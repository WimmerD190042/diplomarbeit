<body style="margin-left: 10px;">
  <div>
    <!-- Verkaufstag anzneige -->
    <h1>Verkaufstag: {{dataService.selectedSalesDay.value.name}}</h1>
    <h5>{{ dataService.getSalesDayDate(dataService.selectedSalesDay.value) | date:'dd.MM.YYYY' }}</h5>

    <!-- Save File -->
    <div id="save-file-button" (click)="exportButtonClick()">
      <button>
        <mat-icon>local_printshop</mat-icon>
      </button>
    </div>
  </div>

  <!-- Oxe mit Button -->
  <table class="table-secondary">
    <tr>
      <td>Oxe</td>
      <td>
        <button class="btn btn-success" (click)="addNameField($event.target)">
          +
        </button>
      </td>
    </tr>
  </table>

  <div id="kunde-wrapper">
    <!-- Kunde Search Bar -->
    <div class="input-group rounded" id="serachCustomerDiv">
      <input id="searchCustomer" type="search" class="form-control rounded" placeholder="Suche nach Kunden"
        aria-label="Search" aria-describedby="search-addon" [formControl]="controlCustomer" [matAutocomplete]="auto1" />
      <span class="input-group-text border-0" id="search-addon">
        <mat-icon>search</mat-icon>
      </span>
    </div>
    <!-- Autocomplete für Kunde Suche -->
    <mat-autocomplete #auto1="matAutocomplete" (optionSelected)="onCustomerSelectMat($event)">
      @for (customer of customerList | async; track customer) {
      <mat-option [value]="customer">{{customer}}</mat-option>
      }
    </mat-autocomplete>

    <!-- Teilstücke Search Bar -->
    <div class="input-group rounded" id="searchPartsDiv">
      <input id="searchParts" type="search" class="form-control rounded" placeholder="Suche nach Teilstücke"
        aria-label="Search" aria-describedby="search-addon" [formControl]="controlParts" [matAutocomplete]="auto2" />
      <span class="input-group-text border-0" id="search-addon">
        <mat-icon>search</mat-icon>
      </span>
    </div>
    <!-- Autocomplete für Teilstück Suche -->
    <mat-autocomplete #auto2="matAutocomplete" (optionSelected)="onMeatPieceSelectedMat($event)">
      @for (meatPiece of filteredAllMeatPiecesSearch | async; track meatPiece) {
      <mat-option [value]="meatPiece">{{meatPiece}}</mat-option>
      }
    </mat-autocomplete>

    <!-- Anmerkung Search Bar-->
    <div class="input-group rounded" id="searchNoteDiv">
      <input id="searchNote" type="search" class="form-control rounded" placeholder="Suche nach Anmerkung"
        aria-label="Search" aria-describedby="search-addon" [(ngModel)]="notesSearchTerm"
        (ngModelChange)="onNoteChanged()" />
      <span class="input-group-text border-0" id="search-addon">
        <mat-icon>search</mat-icon>
      </span>
    </div>
  </div>

  <!-- Show Tabel infos -->
  <table id="table" class="table table-hover">
    <thead>
      <tr>
        <th class="header" scope="col">
          ID
        </th>
        <th class="header" scope="col">
          Kunde
        </th>
        <th class="header" scope="col">
          Kategorie
        </th>
        <th class="header" scope="col">
          Menge (kg)
        </th>
        <th class="header" scope="col">
          Pfand (€)
        </th>
        <th class="header" scope="col">
          Anmerkung
        </th>
        <th class="header"></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>0</td>
        <!-- Todo: Kunde Select -->
        <td>
          <select id="selectPerson" class="form-select" [(ngModel)]="addSelectedCustomerId">
            <option value="" disabled selected>Wählen Sie bitte einen Kunden:</option>
            <option *ngFor="let customer of dataService.customers()" [value]="customer.id">
              {{customer.name}}
            </option>
          </select>
        </td>
        <td>
          <div dropdown class="d-inline-block">
            <div class="dropdown">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1"
                data-bs-toggle="dropdown" aria-expanded="false">
                {{selectedMeatPiece.name && selectedMeatPiece.name!.length > 1 ? selectedMeatPiece.name : 'Auswählen'}}
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                <li *ngFor="let category of dataService.categories()" class="dropdown-submenu"
                  (click)="$event.stopPropagation()">
                  <a class="dropdown-item" (click)="onCategorySelected(category)">{{category.name}}</a>
                  <ul [class.show]="selectedCategory === category" class="dropdown-menu dropdown-submenu">
                    <li *ngFor="let subcategory of selectedCategory?.subCategories" class="dropdown-submenu"
                      (click)="$event.stopPropagation()">
                      <a class="dropdown-item" (click)="onSubCategorySelected(subcategory)">{{subcategory.name}}</a>
                      <ul [class.show]="selectedSubCategory === subcategory" class="dropdown-menu dropdown-submenu">
                        <li *ngFor="let meatpiece of selectedSubCategory?.meatPieces">
                          <a class="dropdown-item" (click)="onMeatPieceSelected(meatpiece)">{{meatpiece.name}}</a>
                        </li>
                      </ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
        </td>
        <td>
          <input [(ngModel)]="quantity" type="number" class="form-control" id="quantity" min="0" placeholder="0.0">
        </td>
        <td>
          <input [(ngModel)]="deposit" type="number" class="form-control" id="deposit" min="0" placeholder="0.0">
        </td>
        <td>
          <textarea id="notes" class="form-control" rows="1" style="height: 36px; overflow-y: hidden;"
            oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"
            [(ngModel)]="notes"></textarea>
        <td>
          <button class="btn btn-success" (click)="addOrder()">
            +
          </button>
          <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
            <li *ngFor="let category of dataService.categories()" class="dropdown-submenu"
              (click)="$event.stopPropagation()">
              <a class="dropdown-item" (click)="onCategorySelected(category)">{{category.name}}</a>
              <ul [class.show]="selectedCategory === category" class="dropdown-menu dropdown-submenu">
                <li *ngFor="let subcategory of selectedCategory?.subCategories" class="dropdown-submenu"
                  (click)="$event.stopPropagation()">
                  <a class="dropdown-item" (click)="onSubCategorySelected(subcategory)">{{subcategory.name}}</a>
                  <ul [class.show]="selectedSubCategory === subcategory" class="dropdown-menu dropdown-submenu">
                    <li *ngFor="let meatpiece of selectedSubCategory?.meatPieces">
                      <a class="dropdown-item" (click)="onMeatPieceSelected(meatpiece)">{{meatpiece.name}}</a>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </td>
      </tr>
      <!-- Orders werden in Liste geladen -->
      <tr *ngFor="let order of filterOrders()">
        <td>{{order.id}}</td>
        <td>{{order.customerName}}</td>
        <td>{{dataService.getMeatPieceFromID(order.meatPieceId!)?.name}}</td>
        <td>{{order.amount}}</td>
        <td>{{order.deposit}}</td>
        <td>{{order.notes}}</td>
        <td>
          <button class="btn btn-danger" (click)="deleteOrder(order)">
            -
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</body>